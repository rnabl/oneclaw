# OneClaw Framework - Technical Architecture

## ğŸ—ï¸ System Architecture (Developer View)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          USER INTERFACES (Multi-Channel)                     â”‚
â”‚  Discord Bot  â”‚  Telegram Bot  â”‚  SMS (Sendblue)  â”‚  iMessage (BlueBubbles) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚               â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         apps/api - API SERVER (Node.js)            â”‚
         â”‚                                                     â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
         â”‚  â”‚  HTTP Routes                                  â”‚ â”‚
         â”‚  â”‚  â€¢ /webhook/stripe (payments)                â”‚ â”‚
         â”‚  â”‚  â€¢ /discord/interactions (buttons)           â”‚ â”‚
         â”‚  â”‚  â€¢ /oauth/google (auth)                      â”‚ â”‚
         â”‚  â”‚  â€¢ /api/v1/workflow (universal API)          â”‚ â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
         â”‚                                                     â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
         â”‚  â”‚  Services                                     â”‚ â”‚
         â”‚  â”‚  â€¢ Discord Bot (WebSocket)                   â”‚ â”‚
         â”‚  â”‚  â€¢ Node Runtime Manager                      â”‚ â”‚
         â”‚  â”‚  â€¢ Email Queue Processor                     â”‚ â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     packages/harness - CORE FRAMEWORK                         â”‚
â”‚                        (Database-Agnostic Layer)                              â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ”Œ PLUGGABLE BACKENDS (Interface-Based)                                â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚ â”‚
â”‚  â”‚  â”‚   Stores         â”‚        â”‚   Cache          â”‚                      â”‚ â”‚
â”‚  â”‚  â”‚  (Persistence)   â”‚        â”‚  (Temporary)     â”‚                      â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ UserStore      â”‚        â”‚ â€¢ get/set/del    â”‚                      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ WalletStore    â”‚        â”‚ â€¢ exists/incr    â”‚                      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ IdentityStore  â”‚        â”‚ â€¢ expire         â”‚                      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ TransactionSt. â”‚        â”‚                  â”‚                      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚ â”‚
â”‚  â”‚           â”‚                           â”‚                                 â”‚ â”‚
â”‚  â”‚  Implementation at Runtime:  Implementation at Runtime:                â”‚ â”‚
â”‚  â”‚  â€¢ Supabase (cloud)          â€¢ Upstash (cloud)                         â”‚ â”‚
â”‚  â”‚  â€¢ SQLite (self-hosted)      â€¢ Valkey (self-hosted)                    â”‚ â”‚
â”‚  â”‚  â€¢ In-Memory (dev)           â€¢ Memory (dev)                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ¯ CORE SERVICES                                                       â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚  â”‚  â”‚  Identity    â”‚  â”‚   Policy     â”‚  â”‚   Metering   â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚  Resolver    â”‚  â”‚   Engine     â”‚  â”‚   Tracker    â”‚                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚ â”‚
â”‚  â”‚  â”‚ Multi-providerâ”‚  â”‚ Rate limits  â”‚  â”‚ Cost per API â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚ user linking  â”‚  â”‚ Quotas       â”‚  â”‚ call trackingâ”‚                 â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚  â”‚  â”‚   Secrets    â”‚  â”‚   Artifacts  â”‚  â”‚   Registry   â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚    Vault     â”‚  â”‚    Store     â”‚  â”‚              â”‚                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚ â”‚
â”‚  â”‚  â”‚ Encrypted    â”‚  â”‚ Logs, screen-â”‚  â”‚ Tool & work- â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚ credentials  â”‚  â”‚ shots, replayâ”‚  â”‚ flow schemas â”‚                 â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸš€ WORKFLOW EXECUTION ENGINE                                           â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚  Runner (Orchestrator)                                        â”‚      â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Job creation & tracking                                    â”‚      â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Step-by-step execution                                     â”‚      â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Progress updates                                           â”‚      â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Error handling & retry                                     â”‚      â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Cost metering                                              â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â”‚           â”‚                                                              â”‚ â”‚
â”‚  â”‚           â–¼                                                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ Discovery         â”‚  â”‚ Enrichment        â”‚  â”‚ Analysis         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ Workflow          â”‚  â”‚ Workflow          â”‚  â”‚ Workflow         â”‚   â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚ â”‚
â”‚  â”‚  â”‚ 1. Apify scrape   â”‚  â”‚ 1. Website scan   â”‚  â”‚ 1. Load data     â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ 2. Parse results  â”‚  â”‚ 2. Owner lookup   â”‚  â”‚ 2. Score leads   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ 3. Scan websites  â”‚  â”‚ 3. Deep audit     â”‚  â”‚ 3. Rank results  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ 4. Cache results  â”‚  â”‚ 4. Generate reportâ”‚  â”‚ 4. Return top 10 â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ”§ INTEGRATIONS                                                        â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚  â”‚  â”‚    Apify     â”‚  â”‚   Website    â”‚  â”‚   Payment    â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚   Client     â”‚  â”‚   Scanner    â”‚  â”‚  Processing  â”‚                 â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚ â”‚
â”‚  â”‚  â”‚ Google Maps  â”‚  â”‚ SEO analysis â”‚  â”‚ Stripe       â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚ scraping     â”‚  â”‚ Tech detectionâ”‚  â”‚ webhooks     â”‚                 â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND IMPLEMENTATIONS (Runtime Selection)                â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  PRODUCTION (Cloud)      â”‚         â”‚  SELF-HOSTED (Local)    â”‚            â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚  â”‚  Stores: Supabase        â”‚         â”‚  Stores: SQLite         â”‚            â”‚
â”‚  â”‚  Cache: Upstash Redis    â”‚         â”‚  Cache: Valkey          â”‚            â”‚
â”‚  â”‚  Durable: Restate Cloud  â”‚         â”‚  Durable: Restate Dockerâ”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  DEVELOPMENT (Minimal)   â”‚         â”‚  TESTING (Fast)         â”‚            â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚  â”‚  Stores: In-Memory       â”‚         â”‚  Stores: In-Memory      â”‚            â”‚
â”‚  â”‚  Cache: In-Memory        â”‚         â”‚  Cache: In-Memory       â”‚            â”‚
â”‚  â”‚  Durable: None           â”‚         â”‚  Durable: None          â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Request Flow (Discovery Workflow Example)

```
1. User types "discover plumbers in Austin, TX" in Discord
   â”‚
   â–¼
2. Discord sends message via WebSocket
   â”‚
   â–¼
3. apps/api/src/services/discord-bot.ts
   â€¢ Parse intent (discovery)
   â€¢ Resolve user identity (Discord ID â†’ internal user ID)
   â€¢ Check wallet balance ($0.50 minimum)
   â”‚
   â–¼
4. packages/harness/src/execution/runner.ts
   â€¢ Create job (EwrBTnjzEsBUD2c2Y4mdN)
   â€¢ Initialize step tracking (0/4)
   â€¢ Inject secrets (Apify key)
   â”‚
   â–¼
5. packages/harness/src/workflows/discovery.ts
   â”‚
   â”œâ”€â–º STEP 1: Prepare (validate input)
   â”‚
   â”œâ”€â–º STEP 2: Search via Apify
   â”‚   â€¢ Check cache first (key: "discovery:plumbers:Austin,TX")
   â”‚   â€¢ Cache miss â†’ Call Apify Google Maps scraper
   â”‚   â€¢ Transform results â†’ 20 businesses
   â”‚   â€¢ Cache for 1 hour
   â”‚
   â”œâ”€â–º STEP 3: Scan websites
   â”‚   â€¢ Extract websites from results (15 have websites)
   â”‚   â€¢ Scan first 10 websites (5 concurrent, 8s timeout)
   â”‚   â€¢ Extract: SEO, booking, chatbot, social, tech stack
   â”‚   â€¢ Update enrichment fields
   â”‚
   â””â”€â–º STEP 4: Finalize
       â€¢ Store artifacts (logs, results)
       â€¢ Return formatted output
   â”‚
   â–¼
6. apps/api/src/workflows/discovery.ts (formatting)
   â€¢ Convert to Discord embed format
   â€¢ Add pagination buttons
   â€¢ Split into fields (1024 char limit)
   â”‚
   â–¼
7. apps/api/src/services/discord-bot.ts
   â€¢ Store results in cache for pagination (key: "pagination:userId:jobId")
   â€¢ Send Discord message with embed
   â€¢ Show 10/20 results (Page 1/2)
   â”‚
   â–¼
8. User clicks "Show More" button
   â”‚
   â–¼
9. Discord sends INTERACTION_CREATE event
   â”‚
   â–¼
10. apps/api/src/services/discord-bot.ts
    â€¢ Load cached results
    â€¢ Format next 10 businesses
    â€¢ Send updated embed (Page 2/2)
```

---

## ğŸ¯ Key Design Principles

### 1. **Progressive Enhancement**
```
Day 1:  In-memory stores + In-memory cache â†’ Works immediately
Week 1: Add Supabase â†’ Persistence
Month 1: Add Upstash â†’ Performance
Month 3: Add Restate â†’ Durability
```

### 2. **Pluggable Backends**
```typescript
// Same code, different backends
const stores = process.env.STORAGE_BACKEND === 'supabase'
  ? createSupabaseStores()
  : createSQLiteStores();

const cache = process.env.CACHE_BACKEND === 'upstash'
  ? createUpstashCache()
  : createMemoryCache();
```

### 3. **Multi-Channel**
```
Discord â†’ WebSocket (persistent connection)
Telegram â†’ Webhook (HTTP POST)
SMS â†’ Sendblue API
iMessage â†’ BlueBubbles API

All â†’ Same workflow execution engine
```

### 4. **Cost Tracking**
```typescript
// Every external API call is metered
ctx.recordApiCall('apify', 'google_maps_scraper', 20);  // $0.08
ctx.recordApiCall('openai', 'gpt-4', 1500);            // $0.02

// Charged to user's wallet
await stores.wallet.debit(userId, 10, 'workflow', jobId);
```

---

## ğŸ”Œ Backend Selection (Runtime)

```typescript
// apps/api/src/index.ts

// Read environment variables
const config = {
  storage: process.env.STORAGE_BACKEND || 'supabase',
  cache: process.env.CACHE_BACKEND || 'upstash',
  durable: process.env.DURABLE_BACKEND || 'none',
};

// Initialize backends at runtime
function initializeBackends(config) {
  // Storage
  if (config.storage === 'supabase') {
    initStores(createSupabaseStores());
  } else if (config.storage === 'sqlite') {
    initStores(createSQLiteStores(process.env.SQLITE_PATH));
  } else {
    initStores(createInMemoryStores());
  }
  
  // Cache
  if (config.cache === 'upstash') {
    initCache(createUpstashCache(
      process.env.UPSTASH_REDIS_REST_URL,
      process.env.UPSTASH_REDIS_REST_TOKEN
    ));
  } else if (config.cache === 'valkey') {
    initCache(createValkeyCache(process.env.CACHE_URL));
  } else {
    initCache(createMemoryCache());
  }
}

// One build, any backend!
```

---

## ğŸ“Š Data Model

```
User
â”œâ”€ id: "397102686660591616" (Discord ID)
â”œâ”€ name: "Alice"
â”œâ”€ avatarUrl: "https://..."
â””â”€ createdAt: Date

Identity (Multi-provider linking)
â”œâ”€ userId: "397102686660591616"
â”œâ”€ provider: "discord"
â”œâ”€ providerId: "397102686660591616"
â””â”€ metadata: { ... }

Wallet (Per-user billing)
â”œâ”€ userId: "397102686660591616"
â”œâ”€ balanceCents: 250  ($2.50)
â”œâ”€ tier: "free"
â””â”€ lifetimeSpentCents: 150  ($1.50)

Transaction (Audit trail)
â”œâ”€ walletId: "wallet_123"
â”œâ”€ type: "debit"
â”œâ”€ amountCents: -50  (-$0.50)
â”œâ”€ source: "workflow"
â”œâ”€ sourceId: "EwrBTnjzEsBUD2c2Y4mdN"
â””â”€ description: "Discovery workflow"
```

---

## ğŸš€ Deployment Models

### Cloud (OneClaw SaaS)
```
Vercel/Railway/Fly.io
â”œâ”€ API Server (Node.js)
â”œâ”€ Supabase (managed Postgres)
â”œâ”€ Upstash (managed Redis)
â””â”€ Restate Cloud (optional)
```

### Self-Hosted (Docker)
```
docker-compose.yml
â”œâ”€ API Server (Node.js)
â”œâ”€ SQLite (file-based)
â”œâ”€ Valkey (Redis-compatible)
â””â”€ Restate (optional)
```

### Local Development
```
npm start
â”œâ”€ API Server (Node.js)
â”œâ”€ In-Memory Stores
â””â”€ In-Memory Cache
```

**Same codebase, different config!**
