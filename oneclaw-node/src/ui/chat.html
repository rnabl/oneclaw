<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - OneClaw Node</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 200px); }
        .messages { flex: 1; overflow-y: auto; padding: 20px; background: #0a0a0a; border: 1px solid #222; border-radius: 8px; margin-bottom: 15px; }
        .message { margin-bottom: 15px; padding: 12px 16px; border-radius: 8px; max-width: 85%; }
        .message.user { background: #1e3a5f; margin-left: auto; }
        .message.assistant { background: #1a1a1a; border: 1px solid #333; }
        .message .role { font-size: 0.75rem; color: #888; margin-bottom: 4px; }
        .message .content { white-space: pre-wrap; line-height: 1.5; }
        .input-area { display: flex; gap: 10px; }
        .input-area textarea { flex: 1; resize: none; height: 60px; }
        .input-area button { width: 100px; }
        .debug-panel { margin-top: 15px; padding: 15px; background: #111; border: 1px solid #222; border-radius: 8px; font-size: 0.8rem; }
        .debug-panel h3 { margin-bottom: 10px; color: #888; }
        .debug-info { color: #666; font-family: monospace; }
        .typing { color: #888; font-style: italic; }
        .clear-btn { background: #333; margin-left: 10px; }
        .clear-btn:hover { background: #444; }
        .tool-calls { margin-top: 10px; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; }
        .tool-call { margin-bottom: 8px; padding: 8px; background: #161b22; border-radius: 4px; }
        .tool-call .tool-name { color: #58a6ff; font-weight: bold; font-size: 0.85rem; }
        .tool-call .tool-duration { color: #8b949e; font-size: 0.75rem; margin-left: 8px; }
        .tool-call .tool-detail { font-size: 0.8rem; color: #8b949e; margin-top: 4px; font-family: monospace; max-height: 100px; overflow: auto; }
        .tool-call.success { border-left: 3px solid #3fb950; }
        .tool-call.error { border-left: 3px solid #f85149; }
        .milestones { margin-top: 10px; padding: 10px; background: #10151d; border: 1px dashed #2f3d52; border-radius: 6px; }
        .milestone { color: #9fb4cf; font-size: 0.82rem; line-height: 1.4; margin: 2px 0; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>OneClaw Chat</h1>
            <div id="status" class="status">Connecting...</div>
        </header>
        
        <nav>
            <a href="/">Dashboard</a>
            <a href="/chat.html" class="active">Chat</a>
            <a href="/receipts.html">Receipts</a>
            <a href="/integrations.html">Integrations</a>
            <a href="/setup.html">Config</a>
        </nav>

        <main>
            <div class="chat-container">
                <div class="messages" id="messages"></div>
                
                <div class="input-area">
                    <textarea id="input" placeholder="Type your message..." onkeydown="handleKeydown(event)"></textarea>
                    <button onclick="sendMessage()">Send</button>
                    <button class="clear-btn" onclick="clearChat()">Clear</button>
                </div>
            </div>
            
            <div class="debug-panel">
                <h3>Debug Info</h3>
                <div class="debug-info" id="debug">
                    <div>Node: <span id="debug-node">-</span></div>
                    <div>Model: <span id="debug-model">-</span></div>
                    <div>Last response: <span id="debug-duration">-</span></div>
                    <div>Messages in context: <span id="debug-messages">0</span></div>
                    <div>Last request: <span id="debug-tools">-</span></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('input');
        
        async function init() {
            try {
                const [healthRes, configRes, historyRes] = await Promise.all([
                    fetch('/health'),
                    fetch('/config'),
                    fetch('/chat/history')
                ]);
                const health = await healthRes.json();
                const config = await configRes.json();
                const history = await historyRes.json();
                
                document.getElementById('status').textContent = 'Online';
                document.getElementById('status').className = 'status online';
                document.getElementById('debug-node').textContent = health.node_name;
                document.getElementById('debug-model').textContent = config.llm.model;
                
                // Render existing history
                history.forEach(msg => addMessage(msg.role, msg.content, [], []));
                updateMessageCount();
            } catch (e) {
                document.getElementById('status').textContent = 'Offline';
                document.getElementById('status').className = 'status offline';
            }
        }
        
        function addMessage(role, content, toolCalls, milestones) {
            const div = document.createElement('div');
            div.className = 'message ' + role;
            
            let html = '<div class="role">' + role + '</div><div class="content"></div>';
            
            // Add tool calls display if present
            if (toolCalls && toolCalls.length > 0) {
                html += '<div class="tool-calls">';
                toolCalls.forEach(tc => {
                    const isError = tc.output && tc.output.error;
                    html += '<div class="tool-call ' + (isError ? 'error' : 'success') + '">';
                    html += '<span class="tool-name">' + tc.tool + '</span>';
                    html += '<span class="tool-duration">' + tc.duration_ms + 'ms</span>';
                    html += '<div class="tool-detail">Input: ' + JSON.stringify(tc.input).substring(0, 200) + '</div>';
                    html += '<div class="tool-detail">Output: ' + JSON.stringify(tc.output).substring(0, 300) + '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }
            if (milestones && milestones.length > 0) {
                html += '<div class="milestones">';
                milestones.slice(0, 6).forEach(m => {
                    html += '<div class="milestone">• ' + m + '</div>';
                });
                html += '</div>';
            }
            
            div.innerHTML = html;
            div.querySelector('.content').textContent = content;
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function addTyping() {
            const div = document.createElement('div');
            div.className = 'message assistant typing';
            div.id = 'typing';
            div.innerHTML = '<div class="role">assistant</div><div class="content">Thinking…</div><div class="content" style="font-size:0.85rem;color:#666;margin-top:6px;">Tool runs (e.g. golf tee time) can take 1–2 min. Keep this tab open; check the daemon terminal for progress.</div>';
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function removeTyping() {
            const el = document.getElementById('typing');
            if (el) el.remove();
        }
        
        function updateMessageCount() {
            const count = messagesEl.querySelectorAll('.message:not(.typing)').length;
            document.getElementById('debug-messages').textContent = count;
        }
        
        async function sendMessage() {
            const message = inputEl.value.trim();
            if (!message) return;
            
            inputEl.value = '';
            addMessage('user', message, [], []);
            addTyping();
            updateMessageCount();
            
            // Long timeout: tool runs (e.g. golf tee time) can take 2–3 min on the harness
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5 * 60 * 1000); // 5 min
            
            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                removeTyping();
                
                if (!res.ok) {
                    const error = await res.text();
                    addMessage('assistant', 'Error: ' + error, []);
                    return;
                }
                
                const data = await res.json();
                addMessage('assistant', data.response, data.tool_calls || [], data.milestones || []);
                document.getElementById('debug-duration').textContent = data.duration_ms + 'ms';
                document.getElementById('debug-tools').textContent = (data.tool_calls || []).length + ' tool calls';
                updateMessageCount();
            } catch (e) {
                clearTimeout(timeoutId);
                removeTyping();
                const msg = e.name === 'AbortError'
                    ? 'Request timed out after 5 minutes. Long runs (e.g. golf search) can take 1–2 min — try again or check the daemon terminal for progress.'
                    : e.message;
                addMessage('assistant', 'Error: ' + msg, [], []);
            }
        }
        
        async function clearChat() {
            await fetch('/chat/clear', { method: 'POST' });
            messagesEl.innerHTML = '';
            updateMessageCount();
        }
        
        function handleKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        init();
    </script>
</body>
</html>
