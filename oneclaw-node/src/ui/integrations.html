<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrations - OneClaw Node</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .integration-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.2s;
        }
        .integration-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .integration-icon {
            font-size: 48px;
            flex-shrink: 0;
        }
        .integration-content {
            flex: 1;
        }
        .integration-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .integration-name {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
        }
        .integration-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-connected {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status-disconnected {
            background: #f5f5f5;
            color: #666;
        }
        .integration-description {
            color: #666;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .integration-email {
            background: #f9fafb;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'SF Mono', monospace;
            font-size: 13px;
            color: #333;
            display: inline-block;
            margin-bottom: 8px;
        }
        .integration-details {
            font-size: 13px;
            color: #999;
            margin-top: 8px;
        }
        .integration-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: white;
            color: #666;
            border: 1px solid #e5e7eb;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            border-color: #667eea;
            color: #667eea;
        }
        .required-for {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }
        .required-for-title {
            font-size: 12px;
            font-weight: 600;
            color: #999;
            margin-bottom: 8px;
        }
        .required-for-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .required-tag {
            background: #f3f4f6;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            color: #555;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        /* Setup Wizard Styles */
        .setup-wizard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 32px;
            color: white;
            margin-bottom: 24px;
        }
        .setup-wizard h3 {
            margin: 0 0 12px 0;
            font-size: 24px;
        }
        .setup-wizard p {
            margin: 0 0 20px 0;
            opacity: 0.9;
            line-height: 1.6;
        }
        .setup-steps {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .setup-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }
        .setup-step:last-child {
            margin-bottom: 0;
        }
        .step-number {
            background: rgba(255,255,255,0.2);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        .setup-code {
            background: rgba(0,0,0,0.2);
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'SF Mono', monospace;
            font-size: 13px;
            margin: 8px 0;
        }
        .btn-setup {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-setup:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .config-missing {
            opacity: 0.6;
            pointer-events: none;
        }
        .config-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }
        
        /* Setup Form Styles */
        .setup-form {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.2);
            color: white;
            font-family: 'SF Mono', monospace;
            font-size: 13px;
        }
        .form-input::placeholder {
            color: rgba(255,255,255,0.5);
        }
        .form-input:focus {
            outline: none;
            border-color: rgba(255,255,255,0.4);
            background: rgba(0,0,0,0.3);
        }
        .form-hint {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }
        .btn-save {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
        }
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .btn-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .success-message {
            background: rgba(46, 125, 50, 0.2);
            border: 1px solid rgba(46, 125, 50, 0.4);
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
        }
        .error-message {
            background: rgba(211, 47, 47, 0.2);
            border: 1px solid rgba(211, 47, 47, 0.4);
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
        }
        
        /* Modal overlay (Step 2: Connect confirmation) */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-box {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .modal-box h3 { margin: 0 0 12px 0; font-size: 18px; }
        .modal-box p { color: #666; margin: 0 0 20px 0; line-height: 1.5; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü¶û OneClaw Node</h1>
            <div id="status" class="status">Connecting...</div>
        </header>
        
        <nav>
            <a href="/">Dashboard</a>
            <a href="/chat.html">Chat</a>
            <a href="/receipts.html">Receipts</a>
            <a href="/integrations.html" class="active">Integrations</a>
            <a href="/setup.html">Config</a>
        </nav>

        <!-- Step 2: Confirm before opening Gmail sign-in -->
        <div id="connect-modal" class="modal-overlay">
            <div class="modal-box">
                <h3>Connect your Gmail</h3>
                <p>We'll open Google in a new tab. Sign in, click Allow, and you're done ‚Äî we'll bring you back here.</p>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeConnectModal()">Cancel</button>
                    <button type="button" class="btn-primary" onclick="confirmConnectAndOpen()">Let's go</button>
                </div>
            </div>
        </div>

        <main>
            <div id="setup-wizard-container"></div>
            
            <section class="card">
                <h2>What's connected</h2>
                <p style="color: #666; margin-bottom: 24px;">
                    Hook up Gmail so your node can read and send on your behalf. One-time setup, then you're set.
                </p>
                <div id="integrations-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚è≥</div>
                        <p>Loading integrations...</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Check for OAuth configuration
        async function checkOAuthConfig() {
            try {
                const res = await fetch('/config');
                const config = await res.json();
                
                const hasControlPlane = config.control_plane && config.control_plane.url;
                
                if (!hasControlPlane) {
                    showSetupWizard('missing_control_plane');
                    return false;
                }
                
                // Check if we can reach the integrations endpoint
                try {
                    const integrationsRes = await fetch('/integrations');
                    if (integrationsRes.ok) {
                        // Integrations API works, assume OAuth is configured
                        return true;
                    }
                } catch (e) {
                    console.error('Failed to fetch integrations:', e);
                }
                
                // If we get here, show the wizard
                showSetupWizard('oauth_not_configured');
                return false;
                
            } catch (e) {
                console.error('Failed to check OAuth config:', e);
                // On error, try to load integrations anyway
                return true;
            }
        }
        
        function showSetupWizard(reason) {
            const wizardContainer = document.getElementById('setup-wizard-container');
            
            let wizardHTML = '';
            
            if (reason === 'missing_control_plane') {
                wizardHTML = `
                    <div class="setup-wizard">
                        <h3>‚öôÔ∏è Almost there ‚Äî one more thing</h3>
                        <p>Your node talks to a small server that handles Gmail sign-in. Set its URL in config and you're good.</p>
                        
                        <div class="setup-steps">
                            <div class="setup-step">
                                <div class="step-number">1</div>
                                <div>
                                    <strong>Get that server running</strong><br>
                                    (It stores your Gmail connection securely.)
                                    <div class="setup-code">cd apps/api && npm run deploy</div>
                                </div>
                            </div>
                            <div class="setup-step">
                                <div class="step-number">2</div>
                                <div>
                                    <strong>Point your node at it</strong><br>
                                    In config, set the URL:
                                    <div class="setup-code">control_plane:<br>  url: https://yourserver.com</div>
                                </div>
                            </div>
                            <div class="setup-step">
                                <div class="step-number">3</div>
                                <div>
                                    <strong>Restart the node</strong> and refresh this page.
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn-setup" onclick="window.location.href='/setup.html'">
                            Open Config
                        </button>
                    </div>
                `;
            } else if (reason === 'oauth_not_configured') {
                wizardHTML = `
                    <div class="setup-wizard">
                        <h3>üîê Step 1: Add your Google keys</h3>
                        <p>One-time thing (~2 min). Paste the two keys from Google below ‚Äî then click <strong>Connect Gmail</strong> to sign in.</p>
                        
                        <div class="setup-form">
                            <div class="form-group">
                                <label class="form-label">Client ID</label>
                                <input 
                                    type="text" 
                                    id="client-id" 
                                    class="form-input" 
                                    placeholder="xxxxx.apps.googleusercontent.com"
                                />
                                <div class="form-hint">From Google Cloud ‚Üí APIs & Services ‚Üí Credentials</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Client Secret</label>
                                <input 
                                    type="password" 
                                    id="client-secret" 
                                    class="form-input" 
                                    placeholder="GOCSPX-xxxxx"
                                />
                                <div class="form-hint">The secret one ‚Äî keep it private.</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Callback URL</label>
                                <input 
                                    type="text" 
                                    id="redirect-uri" 
                                    class="form-input" 
                                    value="https://nabl.ai/api/auth/gmail/callback"
                                />
                                <div class="form-hint">Usually leave as-is. Add this same URL in Google Cloud under your OAuth client.</div>
                            </div>
                            
                            <div id="save-result"></div>
                            
                            <button class="btn-save" onclick="saveOAuthConfig()">
                                Save & continue
                            </button>
                            <button class="btn-setup" onclick="copyFromEnvLocal()">
                                I have a .env ‚Äî paste from there
                            </button>
                            <button class="btn-setup" onclick="skipWizard()">
                                Skip for now
                            </button>
                            <button class="btn-setup" onclick="toggleAdvancedSetup()">
                                Where do I get these?
                            </button>
                        </div>
                        
                        <div id="advanced-setup" style="display: none;">
                            <div class="setup-steps" style="margin-top: 20px;">
                                <p style="opacity: 0.9; margin-bottom: 12px;"><strong>Don't have the keys yet? Get them from Google (free):</strong></p>
                                <div class="setup-step">
                                    <div class="step-number">1</div>
                                    <div>
                                        <strong>Open Google Cloud Console</strong><br>
                                        <a href="https://console.cloud.google.com/" target="_blank" style="color: white; text-decoration: underline;">console.cloud.google.com</a> ‚Üí create a project (or pick one).
                                    </div>
                                </div>
                                <div class="setup-step">
                                    <div class="step-number">2</div>
                                    <div>
                                        <strong>Turn on Gmail API</strong><br>
                                        APIs & Services ‚Üí Library ‚Üí search "Gmail API" ‚Üí Enable.
                                    </div>
                                </div>
                                <div class="setup-step">
                                    <div class="step-number">3</div>
                                    <div>
                                        <strong>Create credentials</strong><br>
                                        APIs & Services ‚Üí Credentials ‚Üí Create Credentials ‚Üí OAuth client ID.<br>
                                        Type: <strong>Web application</strong>. Add the Callback URL from above as an authorized redirect URI.
                                    </div>
                                </div>
                                <div class="setup-step">
                                    <div class="step-number">4</div>
                                    <div>
                                        <strong>Copy Client ID and Client Secret</strong> into the form above.
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn-setup" onclick="window.open('https://console.cloud.google.com/', '_blank')">
                                Open Google Cloud Console
                            </button>
                        </div>
                    </div>
                `;
            } else if (reason === 'control_plane_unreachable') {
                wizardHTML = `
                    <div class="setup-wizard">
                        <h3>üîå Can't reach the server</h3>
                        <p>Check that it's running and the URL in Config is correct ‚Äî then try again.</p>
                        
                        <div class="setup-steps">
                            <div class="setup-step">
                                <div class="step-number">1</div>
                                <div>Open the server URL in your browser and make sure it loads.</div>
                            </div>
                            <div class="setup-step">
                                <div class="step-number">2</div>
                                <div>In Config, double-check <code>control_plane.url</code> matches that URL.</div>
                            </div>
                            <div class="setup-step">
                                <div class="step-number">3</div>
                                <div>If you're on a local network, no firewall blocking the connection.</div>
                            </div>
                        </div>
                        
                        <button class="btn-setup" onclick="window.location.reload()">
                            Try again
                        </button>
                    </div>
                `;
            }
            
            wizardContainer.innerHTML = wizardHTML;
            
            // Disable integration cards
            document.getElementById('integrations-list').style.opacity = '0.5';
            document.getElementById('integrations-list').style.pointerEvents = 'none';
        }
        
        async function loadIntegrations() {
            try {
                const res = await fetch('/integrations');
                if (!res.ok) throw new Error('Failed to fetch');
                const data = await res.json();
                const list = Array.isArray(data.integrations) ? data.integrations : [];
                
                if (list.length === 0) {
                    document.getElementById('integrations-list').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîå</div>
                            <p>Nothing here yet ‚Äî connect Gmail below to get started</p>
                        </div>
                    `;
                    return;
                }
                
                document.getElementById('integrations-list').innerHTML = list.map(integration => {
                    const statusClass = integration.connected ? 'status-connected' : 'status-disconnected';
                    const statusText = integration.connected ? '‚úì Connected' : 'Not Connected';
                    
                    let actions = '';
                    if (integration.connected) {
                        actions = `
                            <div class="integration-email">${integration.email || ''}</div>
                            <div class="integration-details">
                                Connected ${formatDate(integration.connected_at)}
                            </div>
                            <div class="integration-actions">
                                <button class="btn-secondary" onclick="testIntegration('${integration.id}')">
                                    Test Connection
                                </button>
                                <button class="btn-secondary" onclick="disconnectIntegration('${integration.id}')">
                                    Disconnect
                                </button>
                            </div>
                        `;
                    } else {
                        actions = `
                            <div class="integration-actions">
                                <button class="btn-primary" onclick="connectIntegration('${integration.id}')">
                                    Connect ${integration.name}
                                </button>
                            </div>
                        `;
                    }
                    
                    const requiredFor = integration.required_for && integration.required_for.length > 0 ? `
                        <div class="required-for">
                            <div class="required-for-title">This lets your node:</div>
                            <div class="required-for-items">
                                ${integration.required_for.map(item => `<span class="required-tag">${item}</span>`).join('')}
                            </div>
                        </div>
                    ` : '';
                    
                    return `
                        <div class="integration-card">
                            <div class="integration-icon">${integration.icon}</div>
                            <div class="integration-content">
                                <div class="integration-header">
                                    <span class="integration-name">${integration.name}</span>
                                    <span class="integration-status ${statusClass}">${statusText}</span>
                                </div>
                                <div class="integration-description">
                                    ${integration.description}
                                </div>
                                ${actions}
                                ${requiredFor}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (e) {
                console.error('Failed to load integrations:', e);
                document.getElementById('integrations-list').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>Couldn't load the list. Check the node is running and try again.</p>
                    </div>
                `;
            }
        }
        
        let pendingConnectId = null;
        
        function connectIntegration(id) {
            pendingConnectId = id;
            document.getElementById('connect-modal').classList.add('show');
        }
        
        function closeConnectModal() {
            pendingConnectId = null;
            document.getElementById('connect-modal').classList.remove('show');
        }
        
        function confirmConnectAndOpen() {
            const id = pendingConnectId;
            closeConnectModal();
            if (!id) return;
            
            window.open(`/integrations/${id}/connect`, '_blank', 'width=600,height=700');
            
            // Poll for connection status
            const interval = setInterval(async () => {
                const res = await fetch(`/integrations/${id}/status`);
                const data = await res.json();
                if (data.connected) {
                    clearInterval(interval);
                    loadIntegrations();
                    showNotification('Gmail connected ‚Äî you\'re in üéâ');
                }
            }, 2000);
            setTimeout(() => clearInterval(interval), 5 * 60 * 1000);
        }
        
        async function testIntegration(id) {
            alert(`Testing ${id} connection... (not implemented yet)`);
        }
        
        async function disconnectIntegration(id) {
            if (!confirm(`Disconnect ${id}?`)) return;
            alert(`Disconnect functionality coming soon`);
        }
        
        function formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins} minutes ago`;
            if (diffHours < 24) return `${diffHours} hours ago`;
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2e7d32;
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function toggleAdvancedSetup() {
            const advanced = document.getElementById('advanced-setup');
            if (advanced.style.display === 'none') {
                advanced.style.display = 'block';
            } else {
                advanced.style.display = 'none';
            }
        }
        
        function copyFromEnvLocal() {
            // Placeholder - user should paste their own credentials
            document.getElementById('client-id').value = 'YOUR_CLIENT_ID.apps.googleusercontent.com';
            document.getElementById('client-secret').value = 'YOUR_CLIENT_SECRET';
            document.getElementById('redirect-uri').value = 'http://localhost:3000/oauth/google/callback';
            
            const resultDiv = document.getElementById('save-result');
            resultDiv.innerHTML = '<div class="success-message">‚úÖ Pasted. Click "Save & continue" to apply.</div>';
        }
        
        function skipWizard() {
            document.getElementById('setup-wizard-container').innerHTML = '';
            document.getElementById('integrations-list').style.opacity = '1';
            document.getElementById('integrations-list').style.pointerEvents = 'auto';
            loadIntegrations();
        }
        
        async function saveOAuthConfig() {
            const clientId = document.getElementById('client-id').value.trim();
            const clientSecret = document.getElementById('client-secret').value.trim();
            const redirectUri = document.getElementById('redirect-uri').value.trim();
            const resultDiv = document.getElementById('save-result');
            
            // Validation
            if (!clientId || !clientSecret) {
                resultDiv.innerHTML = '<div class="error-message">‚ùå Need both Client ID and Client Secret</div>';
                return;
            }
            
            if (!clientId.includes('.apps.googleusercontent.com')) {
                resultDiv.innerHTML = '<div class="error-message">‚ùå Client ID usually ends with .apps.googleusercontent.com</div>';
                return;
            }
            
            if (!clientSecret.startsWith('GOCSPX-')) {
                resultDiv.innerHTML = '<div class="error-message">‚ùå Client Secret usually starts with GOCSPX-</div>';
                return;
            }
            
            // Disable button
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                // Save to Integration server via API
                const res = await fetch('/config');
                const config = await res.json();
                const harnessUrl = config.control_plane?.url;
                
                if (!harnessUrl) {
                    throw new Error('Control plane URL not configured');
                }
                
                // TODO: Call Integration server API to save OAuth config
                // For now, save to local .env file
                const saveRes = await fetch('/api/oauth/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: clientId,
                        client_secret: clientSecret,
                        redirect_uri: redirectUri,
                    })
                });
                
                if (!saveRes.ok) {
                    throw new Error('Failed to save config');
                }
                
                resultDiv.innerHTML = '<div class="success-message">‚úÖ Saved. Reloading‚Ä¶</div>';
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('Save error:', error);
                resultDiv.innerHTML = `
                    <div class="error-message">
                        ‚ùå ${error.message}<br><br>
                        <strong>You can set them by hand</strong> on the server that handles Gmail sign-in ‚Äî add these env vars and restart:<br>
                        <div class="setup-code" style="margin-top: 8px;">
                            GOOGLE_CLIENT_ID=‚Ä¶<br>
                            GOOGLE_CLIENT_SECRET=‚Ä¶<br>
                            GOOGLE_REDIRECT_URI=‚Ä¶
                        </div>
                    </div>
                `;
                btn.disabled = false;
                btn.textContent = 'Save & continue';
            }
        }
        
        // Load integrations on page load - ALWAYS show the cards
        (async function init() {
            await loadIntegrations();
            const configOK = await checkOAuthConfig();
            if (!configOK) {
                // Wizard is already shown by checkOAuthConfig; don't dim cards so user can still see them
                document.getElementById('integrations-list').style.opacity = '1';
                document.getElementById('integrations-list').style.pointerEvents = 'auto';
            }
        })();
        
        // Also load health for status indicator
        fetch('/health')
            .then(res => res.json())
            .then(data => {
                document.getElementById('status').textContent = 'Online';
                document.getElementById('status').className = 'status online';
            })
            .catch(() => {
                document.getElementById('status').textContent = 'Offline';
                document.getElementById('status').className = 'status offline';
            });
    </script>
</body>
</html>
